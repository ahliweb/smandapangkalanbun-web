Initialising login role...
Connecting to remote database...
Creating shadow database...
Initialising schema...
Seeding globals from roles.sql...
Applying migration 20230101_init_core.sql...
NOTICE (42710): extension "uuid-ossp" already exists, skipping
NOTICE (00000): trigger "on_auth_user_created" for relation "auth.users" does not exist, skipping
Applying migration 20231231_init_admin_menus.sql...
Applying migration 20240101_create_templates_table.sql...
NOTICE (00000): trigger "update_templates_updated_at" for relation "public.templates" does not exist, skipping
Applying migration 20240102_add_templates_menu.sql...
Applying migration 20251217000001_fix_templates_json_structure.sql...
Applying migration 20251217000002_fix_templates_menu_path.sql...
Applying migration 20251218000001_create_tenants_tables.sql...
NOTICE (00000): policy "Platform Admin Manage Tenants" for relation "public.tenants" does not exist, skipping
NOTICE (00000): policy "Users View Own Tenant" for relation "public.tenants" does not exist, skipping
NOTICE (00000): policy "users_select_policy" for relation "public.users" does not exist, skipping
NOTICE (00000): policy "users_insert_policy" for relation "public.users" does not exist, skipping
NOTICE (00000): policy "roles_select_policy" for relation "public.roles" does not exist, skipping
Applying migration 20251218000002_auto_set_tenant_id.sql...
NOTICE (00000): trigger "trg_set_tenant_id" for relation "public.templates" does not exist, skipping
Applying migration 20251218000003_add_tenants_deleted_at.sql...
Applying migration 20251218000004_add_is_system_to_roles.sql...
Applying migration 20251218000005_update_handle_new_user.sql...
Applying migration 20251218000006_phase2_content_isolation.sql...
Applying migration 20251218000007_phase3_subscription_limits.sql...
NOTICE (00000): trigger "tr_enforce_user_limit" for relation "public.users" does not exist, skipping
Applying migration 20251218000008_global_module_update.sql...
NOTICE (00000): policy "Tenant Read Access" for relation "public.templates" does not exist, skipping
NOTICE (00000): policy "Tenant Write Access" for relation "public.templates" does not exist, skipping
ERROR: relation "public.extensions" does not exist (SQLSTATE 42P01)                                                                                                                            
At statement: 0                                                                                                                                                                                
-- Migration: 20251218_global_module_update                                                                                                                                                    
-- Description: Add tenant_id and RLS policies to all remaining modules for multi-tenancy.                                                                                                     
                                                                                                                                                                                               
-- List of tables to update:                                                                                                                                                                   
-- announcements, promotions, testimonies, portfolio                                                                                                                                           
-- menus, tags, categories                                                                                                                                                                     
-- contact_messages, product_types                                                                                                                                                             
-- themes, templates                                                                                                                                                                           
-- extensions, extension_routes                                                                                                                                                                
-- photo_gallery, video_gallery                                                                                                                                                                
                                                                                                                                                                                               
DO $$                                                                                                                                                                                          
DECLARE                                                                                                                                                                                        
    t text;                                                                                                                                                                                    
    tables text[] := ARRAY[                                                                                                                                                                    
        'announcements', 'promotions', 'testimonies', 'portfolio',                                                                                                                             
        'menus', 'tags', 'categories',                                                                                                                                                         
        'contact_messages', 'product_types',                                                                                                                                                   
        'themes', 'templates',                                                                                                                                                                 
        'extensions', 'extension_routes',                                                                                                                                                      
        'photo_gallery', 'video_gallery'                                                                                                                                                       
    ];                                                                                                                                                                                         
BEGIN                                                                                                                                                                                          
    FOREACH t IN ARRAY tables LOOP                                                                                                                                                             
            IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = t) THEN                                                                                                      
                    -- 1. Add tenant_id column if it doesn't exist                                                                                                                             
                    IF NOT EXISTS (                                                                                                                                                            
                            SELECT 1 FROM information_schema.columns                                                                                                                           
                            WHERE table_name = t AND column_name = 'tenant_id'                                                                                                                 
                    ) THEN                                                                                                                                                                     
                            EXECUTE format('ALTER TABLE public.%I ADD COLUMN tenant_id UUID REFERENCES public.tenants(id);', t);                                                               
                            EXECUTE format('CREATE INDEX IF NOT EXISTS idx_%I_tenant_id ON public.%I(tenant_id);', t, t);                                                                      
                    END IF;                                                                                                                                                                    
                                                                                                                                                                                               
                    -- 2. Enable RLS                                                                                                                                                           
                    EXECUTE format('ALTER TABLE public.%I ENABLE ROW LEVEL SECURITY;', t);                                                                                                     
                                                                                                                                                                                               
                    -- 3. Drop existing policies to avoid conflicts (clean slate for these tables)                                                                                             
                    -- We use a safe drop pattern that iterates over existing policies if needed,                                                                                              
                    -- but for simplicity in this block we'll just try to drop known standard ones or ignore errors if complex.                                                                
                    -- Better approach: Create new policies with unique names.                                                                                                                 
                                                                                                                                                                                               
                    -- POLICY: Read Access                                                                                                                                                     
                    -- Allow access if:                                                                                                                                                        
                    -- a) Row belongs to current tenant                                                                                                                                        
                    -- b) User is platform admin (super_super_admin)                                                                                                                           
                    -- c) Table is 'themes' or 'templates' and tenant_id is NULL (System default themes)                                                                                       
                                                                                                                                                                                               
                    EXECUTE format('DROP POLICY IF EXISTS "Tenant Read Access" ON public.%I;', t);                                                                                             
                    IF t IN ('themes', 'templates') THEN                                                                                                                                       
                            EXECUTE format(                                                                                                                                                    
                                    'CREATE POLICY "Tenant Read Access" ON public.%I FOR SELECT USING ( (tenant_id = current_tenant_id()) OR (tenant_id IS NULL) OR (is_platform_admin()) );', 
                                    t                                                                                                                                                          
                            );                                                                                                                                                                 
                    ELSE                                                                                                                                                                       
                            EXECUTE format(                                                                                                                                                    
                                    'CREATE POLICY "Tenant Read Access" ON public.%I FOR SELECT USING ( (tenant_id = current_tenant_id()) OR (is_platform_admin()) );',                        
                                    t                                                                                                                                                          
                            );                                                                                                                                                                 
                    END IF;                                                                                                                                                                    
                                                                                                                                                                                               
                    -- POLICY: Write Access (Insert/Update/Delete)                                                                                                                             
                    -- Allow if:                                                                                                                                                               
                    -- a) Row belongs to current tenant AND user is admin+                                                                                                                     
                    -- b) User is platform admin                                                                                                                                               
                                                                                                                                                                                               
                    EXECUTE format('DROP POLICY IF EXISTS "Tenant Write Access" ON public.%I;', t);                                                                                            
                    EXECUTE format(                                                                                                                                                            
                            'CREATE POLICY "Tenant Write Access" ON public.%I FOR ALL USING ( (tenant_id = current_tenant_id() AND is_admin_or_above()) OR (is_platform_admin()) );',          
                            t                                                                                                                                                                  
                    );                                                                                                                                                                         
            END IF;                                                                                                                                                                            
    END LOOP;                                                                                                                                                                                  
END $$                                                                                                                                                                                         
Try rerunning the command with --debug to troubleshoot the error.
